$(function(){function p(a){a=a||window.event;j="focus"==a.type||"focusin"==a.type?"visible":"blur"==a.type||"focusout"==a.type?"hidden":this[g]?"hidden":"visible";"visible"==j&&h&&(h=0,l())}function l(){window.setTimeout(function(){$("title").html(ich.title_template({count:h},!0))},100)}function q(a){a.masonry({itemSelector:".chat-box",stamp:".retained_1",visibleStyle:{opacity:1,transform:"scale(1)"},isAnimated:!0,animationOptions:{duration:550,easing:"linear",queue:!1}})}function r(){$(".chat-list .loading").remove()}function i(a,c,f){var c={type:a,text:c},b=$(".noticeWrap");b.append(ich.notice_template(c)).addClass(a).animate({top:0},200);var d=$(".noticeWrap").height();setTimeout(function(){b.stop().animate({top:-d},300,function(){b.html("").attr("class","noticeWrap")})},f)}var j,h=0,b=$(".chat");l();b.append(ich.loading());var d=io.connect("",{"connect timeout":1E3});d.on("error",function(a){console.error("Unable to connect Socket.IO !!",a)});d.on("connect",function(){0===b.find(".chat-box").length&&d.emit("history request")});d.on("history response",function(a){a.history&&a.history.length?(a.history.forEach(function(a){var f;f=!/[\u4e00-\u9fa5]/g.test(a.message)?"en":"cn";a={id:a.id,msg:a.message,lang:f,retained:a.retained,time:(new Date(a.creation_ts)).format("yyyy-MM-dd hh:mm:ss")};b.append(s(ich.chat_box(a)))}),$(".time").timeago(),q(b),r()):(r(),b.append(ich.nullbox()))});d.on("new msg",function(a){a.retained=0;a.lang=!/[\u4e00-\u9fa5]/g.test(a.msg)?"en":"cn";a=s(ich.chat_box(a));0===b.find(".chat-box").length?(b.prepend(a),q(b)):b.prepend(a).masonry("prepended",a);$(".time").timeago();$(".chat .nullbox").remove();"hidden"===j&&(h+=1,l(),$("#chatAudio")[0].play())});d.on("message deleted",function(a){a=$('.chat-box[data-id="'+a.id+'"]');0<a.find(".progressWrapper").size()&&clearTimeout(a.delTime);b.masonry("remove",a);b.masonry();b.masonry("on","removeComplete",function(a){0===a.items.length&&(b.append(ich.nullbox()),b.masonry("destroy"))});"hidden"===j&&$("#deletedAudio")[0].play()});$(".chat-list").hammer({hold_timeout:1E3,stop_browser_behavior:{userSelect:""}}).on("hold",".chat-box",function(){var a=$(this);a.hasClass("waiting")||1===a.data("retained")||(a.append(ich.confirm_template()),a.addClass("waiting animate"),a.find(".delete").click(function(){a.find("p").append(ich.progress());$(this).hide();var c=$(this).parents(".chat-box").eq(0).find(".imgbox").data("key");a.delTime=setTimeout(function(){var f=a.data("id");c?d.emit("delete message",{id:f,imgKey:c.toString()}):d.emit("delete message",{id:f});b.masonry("remove",a);clearTimeout(a.delTime)},5E3)}),a.find(".cancel").click(function(){a.removeClass("waiting animate");a.find(".confirm").remove();a.find(".progressWrapper").remove();clearTimeout(a.delTime)}))});$(".chat-input textarea").keypress(function(a){var c=$(this).val().trim().replace(/\r\n/gi,"");switch(a.keyCode){case 13:if(!a.shiftKey&&c)return a=c.substring(0,240),/(http:\/\/www.xiami.com\/song\/[0-9]+)\s?/g.test(a)?d.emit("my msg",{msg:a,song:!0}):d.emit("my msg",{msg:a}),$(this).val(""),!1}});var v=function(a){var c=/(http:\/\/ww[0-9]{1}.sinaimg.cn\/[a-zA-Z0-9]+\/[a-zA-Z0-9]+.[a-z]{3})/g,f=/(http:\/\/[a-zA-Z0-9_\-]+.qiniudn.com\/[a-zA-Z0-9_=?\/]+)/g,b=/(http:\/\/distilleryimage[0-9]{1,2}.ak.instagram.com\/[a-zA-Z0-9_]+.jpg)/g,d=/(http:\/\/www.xiami.com\/song\/[0-9]+)\s?/g,a=a.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,function(a){if(c.test(a)||b.test(a))a='<div class="imgbox"><div style="background-image:url('+a+');background-size: cover;"></div></div>';else if(f.test(a)){var t;a.replace(/(com\/[A-Za-z0-9_=]+)/g,function(a,c){t=c.replace("com/","")});a='<div data-key="'+t+'" class="imgbox"><div style="background-image:url('+a+');background-size: cover;"></div></div>'}else if(d.test(a)){var m;a.replace(/(song\/[0-9]+)/g,function(a,c){console.log("s",a);console.log("value",c);m=c.replace("song/","")});console.log("songid",m);a='<embed src="http://www.xiami.com/widget/15289_'+m+'/singlePlayer.swf" type="application/x-shockwave-flash" width="257" height="33" wmode="transparent"></embed>'}else a='<a href="'+a+'" target="_blank">'+a+"</a>";return a});return a=a.replace(/(@)([a-zA-Z0-9_]+)/g,'<a href="http://twitter.com/$2" target="_blank">$1$2</a>')},s=function(a){var c=a.find("p"),b=c.html();c.html(v(b));return a};Date.prototype.format=function(a){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var b in c)RegExp("("+b+")").test(a)&&(a=a.replace(RegExp.$1,1==RegExp.$1.length?c[b]:("00"+c[b]).substr((""+c[b]).length)));return a};$.timeago.settings={refreshMillis:1E3,allowFuture:!1,localeTitle:!0,cutoff:0,strings:{prefixAgo:null,prefixFromNow:null,suffixAgo:"ago",suffixFromNow:"from now",seconds:"less than a minute",minute:"about a minute",minutes:"%d minutes",hour:"about an hour",hours:"about %d hours",day:"a day",days:"%d days",month:"about a month",months:"%d months",year:"about a year",years:"%d years",wordSeparator:" ",numbers:[]}};var g,e,n={hidden:"visibilitychange",mozHidden:"mozvisibilitychange",webkitHidden:"webkitvisibilitychange",msHidden:"msvisibilitychange",oHidden:"ovisibilitychange"};for(g in n)if(n.hasOwnProperty(g)&&g in document){e=n[g];break}e?document.addEventListener(e,p):window.onfocus=window.onblur=p;$("#Tips li").click(function(){var a=$(this).attr("id");"about"===a?$("body").append(ich.about_content_template()):"usage"===a&&$("body").append(ich.usage_content_template());setTimeout(function(){$("body").addClass("intro-wrap-open")},0)});$("body").on("click",".intro-wrap-close",function(){$(".intro-wrap").addClass("intro-wrap-closing");setTimeout(function(){$("body").removeClass("intro-wrap-open");$(".intro-wrap").remove()},300)});$(".chat-input textarea").focus(function(){$("#Tips").stop().animate({top:-100},200)}).blur(function(){$("#Tips").stop().animate({top:0},200)});var u=$(".chat-input").data("bucket"),k=!1;e=document.getElementById("drop_zone");var o=$("#drop_zone"),w=["image/jpeg","image/png","image/gif","image/bmp"];e.addEventListener("dragover",function(a){a.stopPropagation();a.preventDefault();o.addClass("dragOver");a.dataTransfer.dropEffect="copy"},!1);e.addEventListener("dragleave",function(a){a.stopPropagation();a.preventDefault();o.removeClass("dragOver")},!1);e.addEventListener("drop",function(a){a.stopPropagation();a.preventDefault();o.removeClass("dragOver");var a=a.dataTransfer.files,c;if(k)i("error","\u8fd8\u6709\u6ca1\u4e0a\u4f20\u5b8c\u7684 :)",2E3);else if(a&&1<a.length)i("error","\u4e00\u6b21\u53ea\u4e0a\u4f20\u4e00\u4e2a\u6587\u4ef6\u5c31\u53ef\u4ee5 :)",2E3);else if(a&&0<a.length)for(var b=0;file=a[b];b++){if(!file.type||0>$.inArray(file.type,w)){i("error","\u5509\uff0c\u4e0a\u4f20\u56fe\u7247\u624d\u53ef\u4ee5\u554a",2E3);break}if(2E6<file.size){i("error","\u827e\u739b\uff01\u6587\u4ef6\u592a\u5927\u4e86\uff01\u51cf\u51cf\u80a5\uff0c\u8981\u5c0f\u4e8e2M\u624d\u53ef\u4ee5\u3002",2E3);break}if(0<$("#imagePreview").size()){i("error","\u522b\u7740\u6025\uff0c\u4e00\u4e2a\u4e00\u4e2a\u6765",2E3);break}var d={},e=file.name.replace(/[ ]/g,""),g=(new Date).getTime();d.key=base64encode(e)+"_"+g;c=file;$("#upimg").fadeIn().css({background:"#fff"});e=new FileReader;e.onload=function(){return function(a){var b=document.createElement("div");b.setAttribute("id","imageThumb");b.setAttribute("style","background:url("+a.target.result+") center center no-repeat;background-size:cover;");document.getElementById("upimg").insertBefore(b,null)}}(file);e.readAsDataURL(file);$.ajax({url:"/sign",type:"POST",cache:!1,data:{putExtra:JSON.stringify(d)},dataType:"json",success:function(a){$("#upimg").append(ich.upload_progress());a=a.token;k=!0;var b=new XMLHttpRequest;b.open("POST","http://up.qiniu.com",!0);var e,f;e=new FormData;e.append("token",a);e.append("file",c);e.append("key",d.key);var g;b.upload.addEventListener("progress",function(a){if(a.lengthComputable){g=(new Date).getTime()-f;var b=a.loaded/1024/(g/1E3);1024<b?(b/1024).toFixed(2):b.toFixed(2);a=Math.round(100*a.loaded/a.total);$(".chat-input .progress .bar").height(a+"%");"100"==a&&$("#upimg .bar").html('<i class="fa fa-spinner fa-spin"></i>')}},!1);b.onreadystatechange=function(a){4==b.readyState&&200==b.status&&""!=b.responseText?(a=JSON.parse(b.responseText),$(".chat-input .progress").remove(),$("#imageThumb").remove(),$("#upimg").css({background:"none","box-shadow":"none"}),a={key:a.key,path:"http://"+u+".qiniudn.com/"+a.key+"?imageView/1/w/200/h/200"},$("#upimg").append(ich.image_preview(a)),k=!1):200!=b.status&&b.responseText&&(console.log("xhr.responseText",b.responseText),console.log("response",a),k=!1)};f=(new Date).getTime();b.send(e)},error:function(){}})}},!1);$(".chat-input").on("click","#previewControl .delete",function(){var a=$(this).data("id");$.ajax({url:"/delete",type:"POST",cache:!1,data:{key:a},dataType:"json",success:function(){$("#upimg").html("").hide()},error:function(a,b,d){console.log(a);console.log(b);console.log(d.error)}})}).on("click","#previewControl .publish",function(){var a=$(this).data("id").toString();d.emit("my msg",{msg:"http://"+u+".qiniudn.com/"+a+"?imageView/1/w/500/h/500",imgKey:a});$("#upimg").html("").hide()})});