/* 
* @Author: hanjiyun
* @Date:   2013-11-02 18:53:14
* @Last Modified by:   hanjiyun
* @Last Modified time: 2014-03-15 19:09:00
*/
/*

                              _,add8ba,
                            ,d888888888b,
                           d8888888888888b                        _,ad8ba,_
                          d888888888888888)                     ,d888888888b,
                          I8888888888888888 _________          ,8888888888888b
                __________`Y88888888888888P"""""""""""baaa,__ ,888888888888888,
            ,adP"""""""""""9888888888P""^                 ^""Y8888888888888888I
         ,a8"^           ,d888P"888P^                           ^"Y8888888888P'
       ,a8^            ,d8888'                                     ^Y8888888P'
      a88'           ,d8888P'                                        I88P"^
    ,d88'           d88888P'                                          "b,
   ,d88'           d888888'                                            `b,
  ,d88'           d888888I                                              `b,
  d88I           ,8888888'            ___                                `b,
 ,888'           d8888888          ,d88888b,              ____            `b,
 d888           ,8888888I         d88888888b,           ,d8888b,           `b
,8888           I8888888I        d8888888888I          ,88888888b           8,
I8888           88888888b       d88888888888'          8888888888b          8I
d8886           888888888       Y888888888P'           Y8888888888,        ,8b
88888b          I88888888b      `Y8888888^             `Y888888888I        d88,
Y88888b         `888888888b,      `""""^                `Y8888888P'       d888I
`888888b         88888888888b,                           `Y8888P^        d88888
 Y888888b       ,8888888888888ba,_          _______        `""^        ,d888888
 I8888888b,    ,888888888888888888ba,_     d88888888b               ,ad8888888I
 `888888888b,  I8888888888888888888888b,    ^"Y888P"^      ____.,ad88888888888I
  88888888888b,`888888888888888888888888b,     ""      ad888888888888888888888'
  8888888888888698888888888888888888888888b_,ad88ba,_,d88888888888888888888888
  88888888888888888888888888888888888888888b,`"""^ d8888888888888888888888888I
  8888888888888888888888888888888888888888888baaad888888888888888888888888888'
  Y8888888888888888888888888888888888888888888888888888888888888888888888888P
  I888888888888888888888888888888888888888888888P^  ^Y8888888888888888888888'
  `Y88888888888888888P88888888888888888888888888'     ^88888888888888888888I
   `Y8888888888888888 `8888888888888888888888888       8888888888888888888P'
    `Y888888888888888  `888888888888888888888888,     ,888888888888888888P'
     `Y88888888888888b  `88888888888888888888888I     I888888888888888888'
       "Y8888888888888b  `8888888888888888888888I     I88888888888888888'
         "Y88888888888P   `888888888888888888888b     d8888888888888888'
            ^8888888888^   `Y88888888888888888888,    888888888888888P'
              ^JiyunÂ·Han^    "8888888888888888888b,   Y888888888888P^
                ^Paloalto^    `Y888888888888888888b   `Y8888888P"^
                                "Y8888888888888888P     `""""^
                                  `"YY88888888888P'
                                       ^""""""""'

*/
$(function(){function s(a){a=a||window.event;i="focus"==a.type||"focusin"==a.type?"visible":"blur"==a.type||"focusout"==a.type?"hidden":this[j]?"hidden":"visible";"visible"==i&&g&&(g=0,k())}function k(){window.setTimeout(function(){$("title").html(ich.title_template({count:g},!0))},100)}function n(a){a.masonry({itemSelector:".chat-box",stamp:".retained_1",visibleStyle:{opacity:1,transform:"scale(1)"},isAnimated:!0,animationOptions:{duration:550,easing:"linear",queue:!1}})}function t(){$(".chat .nullbox").remove()}
function f(a,c,b){var c={type:a,text:c},e=$(".noticeWrap");e.append(ich.notice_template(c)).addClass(a).animate({top:0},200);var l=$(".noticeWrap").height();setTimeout(function(){e.stop().animate({top:-l},300,function(){e.html("").attr("class","noticeWrap")})},b)}function u(){$(".cp-jplayer").each(function(){var a=$(this);if("1"!==a.data("inited")){var c=a.data("id"),b=a.data("location");a.data("inited","1");new CirclePlayer("#jquery_jplayer_"+c,{mp3:b},{cssSelectorAncestor:"#cp_container_"+c,supplied:"mp3"})}})}
function v(a){a=document.cookie.match(RegExp("(^| )"+a+"=([^;]*)(;|$)"));return null!=a?unescape(a[2]):null}var i,g=0,e=$(".chat");k();e.append(ich.loader());var d=io.connect("",{"connect timeout":1E3});d.on("error",function(a){console.error("Unable to connect Socket.IO !!",a)});d.on("connect",function(){0===e.find(".chat-box").length&&d.emit("history request")});d.on("history response",function(a){a.history&&a.history.length?(a.history.forEach(function(a){var b;b=o(a.message)?"en":"cn";var d=new Date(a.creation_ts),
l=a.message;/www.xiami.com\/song\/\d+/.test(l)?(a={id:a.id,songOriginal:l,title:a.music_title,artist:a.music_artist,album:a.music_album,cover:a.music_cover,location:a.music_location,lang:b,retained:a.retained,time:d.format("yyyy-MM-dd hh:mm:ss")},e.append(w(ich.music_box(a)))):(a={id:a.id,msg:l,lang:b,retained:a.retained,time:d.format("yyyy-MM-dd hh:mm:ss")},e.append(x(ich.chat_box(a))))}),u(),$(".time").timeago(),n(e),$(".loader").remove()):($(".loader").remove(),e.append(ich.nullbox()))});d.on("new msg",
function(a){a.retained=0;a.lang=o(a.msg)?"en":"cn";a=x(ich.chat_box(a));0===e.find(".chat-box").length?(e.prepend(a),n(e)):e.prepend(a).masonry("prepended",a);$(".time").timeago();t();"hidden"===i&&(g+=1,k(),$("#chatAudio")[0].play())});d.on("new song",function(a){a.retained=0;a.lang=o(a.message)?"en":"cn";a={id:a.id,songOriginal:a.songOriginal,title:a.song.title,artist:a.song.artist,album:a.song.album,cover:a.song.cover,location:a.song.location,retained:a.retained,time:(new Date(a.time)).format("yyyy-MM-dd hh:mm:ss")};
a=w(ich.music_box(a));0===e.find(".chat-box").length?(e.prepend(a),n(e)):e.prepend(a).masonry("prepended",a);u();$(".time").timeago();t();"hidden"===i&&(g+=1,k(),$("#chatAudio")[0].play())});d.on("message deleted",function(a){a=$('.chat-box[data-id="'+a.id+'"]');0<a.find(".progressWrapper").size()&&clearTimeout(a.delTime);e.masonry("remove",a);e.masonry();e.masonry("on","removeComplete",function(a){0===a.items.length&&0===$(".nullbox").size()&&(e.append(ich.nullbox()),e.masonry("destroy"))});"hidden"===
i&&(0<g&&(g-=1,k()),$("#deletedAudio")[0].play())});$(".chat").hammer({hold_timeout:1E3,stop_browser_behavior:{userSelect:""}}).on("hold",".chat-box",function(){var a=$(this);a.hasClass("waiting")||1===a.data("retained")||(a.append(ich.confirm_template()),a.addClass("waiting animate"),a.find(".delete").click(function(){a.find(".inner").append(ich.progress());$(this).hide();var c=$(this).parents(".chat-box").eq(0).find(".imgbox").data("key");a.delTime=setTimeout(function(){var b=a.data("id");c?d.emit("delete message",
{id:b,imgKey:c.toString()}):d.emit("delete message",{id:b});e.masonry("remove",a);clearTimeout(a.delTime)},800)}),a.find(".cancel").click(function(){a.removeClass("waiting animate");a.find(".confirm").remove();a.find(".progressWrapper").remove();clearTimeout(a.delTime)}))});$(".chat-input textarea").keypress(function(a){var c=$(this).val().trim().replace(/\r\n/gi,"");switch(a.keyCode){case 13:if(!a.shiftKey&&c)return a=c.substring(0,240),/(http:\/\/www.xiami.com\/song\/[0-9]+)\s?/g.test(a)?(f("success",
"\u8bf7\u7a0d\u7b49\uff0c\u6b63\u5728\u89e3\u6790\u97f3\u4e50\u4fe1\u606f....",4E3),d.emit("my msg",{msg:a,song:!0})):d.emit("my msg",{msg:a}),$(this).val(""),!1}});var y=function(a){var c=/(http:\/\/ww[0-9]{1}.sinaimg.cn\/[a-zA-Z0-9]+\/[a-zA-Z0-9]+.[a-z]{3})/g,b=/(http:\/\/[a-zA-Z0-9_\-]+.qiniudn.com\/[a-zA-Z0-9_=?\/]+)/g,e=/(http:\/\/distilleryimage[0-9]{1,2}.ak.instagram.com\/[a-zA-Z0-9_]+.jpg)/g,d=/(http:\/\/www.xiami.com\/song\/[0-9]+)\s?/g,a=a.replace(/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,
function(a){if(c.test(a)||e.test(a))a='<div class="imgbox"><div style="background-image:url('+a+');background-size: cover;"></div></div><a href="'+a+'" target="_blank" class="view_full_size" title="\u67e5\u770b\u539f\u56fe"><i class="fa fa-dot-circle-o"></i><span>Full size</span></a>';else if(b.test(a)){var f;a.replace(/(com\/[A-Za-z0-9_=]+)/g,function(a,c){f=c.replace("com/","")});a='<div data-key="'+f+'" class="imgbox"><div style="background-image:url('+a+');background-size: cover;"></div></div><a href="'+
("http://"+p+".qiniudn.com/"+f)+'" target="_blank" class="view_full_size" title="\u67e5\u770b\u539f\u56fe"><i class="fa fa-dot-circle-o"></i><span>Full size</span></a>'}else a=d.test(a)?'<embed src="http://www.xiami.com/widget/0_'+/(\d+)/.exec(a)[1]+'/singlePlayer.swf" type="application/x-shockwave-flash" width="257" height="33" wmode="transparent"></embed>':'<a href="'+a+'" target="_blank">'+a+"</a>";return a});return a=a.replace(/(@)([a-zA-Z0-9_]+)/g,'<a href="http://twitter.com/$2" target="_blank">$1$2</a>')},
x=function(a){var c=a.find("p"),b=c.html();c.html(y(b));return a},w=function(a){var c=a.find(".musicBoxWapper"),b=c.html();c.html(b);return a},o=function(a){return/[\u4e00-\u9fa5]/g.test(a)?!1:!0};Date.prototype.format=function(a){var c={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));
for(var b in c)RegExp("("+b+")").test(a)&&(a=a.replace(RegExp.$1,1==RegExp.$1.length?c[b]:("00"+c[b]).substr((""+c[b]).length)));return a};$.timeago.settings={refreshMillis:1E3,allowFuture:!1,localeTitle:!0,cutoff:0,strings:{prefixAgo:null,prefixFromNow:null,suffixAgo:"ago",suffixFromNow:"from now",seconds:"less than a minute",minute:"about a minute",minutes:"%d minutes",hour:"about an hour",hours:"about %d hours",day:"a day",days:"%d days",month:"about a month",months:"%d months",year:"about a year",
years:"%d years",wordSeparator:" ",numbers:[]}};var j,h,q={hidden:"visibilitychange",mozHidden:"mozvisibilitychange",webkitHidden:"webkitvisibilitychange",msHidden:"msvisibilitychange",oHidden:"ovisibilitychange"};for(j in q)if(q.hasOwnProperty(j)&&j in document){h=q[j];break}h?document.addEventListener(h,s):window.onfocus=window.onblur=s;$("#Tips li").click(function(){var a=$(this).attr("id");"about"===a?$("body").append(ich.about_content_template()):"usage"===a&&$("body").append(ich.usage_content_template());
setTimeout(function(){$("body").addClass("intro-wrap-open")},0)});$("body").on("click",".intro-wrap-close",function(){$(".intro-wrap").addClass("intro-wrap-closing");setTimeout(function(){$("body").removeClass("intro-wrap-open");$(".intro-wrap").remove()},300)});var p=$(".chat-input").data("bucket"),m=!1;h=document.getElementById("drop_zone");var r=$("#drop_zone"),z=["image/jpeg","image/png","image/gif","image/bmp"];h.addEventListener("dragover",function(a){a.stopPropagation();a.preventDefault();
r.addClass("dragOver");a.dataTransfer.dropEffect="copy"},!1);h.addEventListener("dragleave",function(a){a.stopPropagation();a.preventDefault();r.removeClass("dragOver")},!1);h.addEventListener("drop",function(a){a.stopPropagation();a.preventDefault();r.removeClass("dragOver");var a=a.dataTransfer.files,c;if(m)f("error","\u8fd8\u6709\u6ca1\u4e0a\u4f20\u5b8c\u7684 :)",2E3);else if(a&&1<a.length)f("error","\u4e00\u6b21\u53ea\u4e0a\u4f20\u4e00\u4e2a\u6587\u4ef6\u5c31\u53ef\u4ee5 :)",2E3);else if(a&&0<
a.length)for(var b=0;file=a[b];b++){if(!file.type||0>$.inArray(file.type,z)){f("error","\u5509\uff0c\u4e0a\u4f20\u56fe\u7247\u624d\u53ef\u4ee5\u554a",2E3);break}if(2E6<file.size){f("error","\u827e\u739b\uff01\u6587\u4ef6\u592a\u5927\u4e86\uff01\u51cf\u51cf\u80a5\uff0c\u8981\u5c0f\u4e8e2M\u624d\u53ef\u4ee5\u3002",2E3);break}if(0<$("#imagePreview").size()){f("error","\u522b\u7740\u6025\uff0c\u4e00\u4e2a\u4e00\u4e2a\u6765",2E3);break}var e={},d=file.name.replace(/[ ]/g,""),g=(new Date).getTime();e.key=
base64encode(d)+"_"+g;c=file;$("#upimg").fadeIn().css({background:"#fff"});d=new FileReader;d.onload=function(){return function(a){var c=document.createElement("div");c.setAttribute("id","imageThumb");c.setAttribute("style","background:url("+a.target.result+") center center no-repeat;background-size:cover;");document.getElementById("upimg").insertBefore(c,null)}}(file);d.readAsDataURL(file);$.ajax({url:"/sign",type:"POST",cache:!1,data:{putExtra:JSON.stringify(e)},dataType:"json",success:function(a){$("#upimg").append(ich.upload_progress());
a=a.token;m=!0;var b=new XMLHttpRequest;b.open("POST","http://up.qiniu.com",!0);var d,f;d=new FormData;d.append("token",a);d.append("file",c);d.append("key",e.key);var g;b.upload.addEventListener("progress",function(a){if(a.lengthComputable){g=(new Date).getTime()-f;var b=a.loaded/1024/(g/1E3);1024<b?(b/1024).toFixed(2):b.toFixed(2);a=Math.round(100*a.loaded/a.total);$(".chat-input .progress .bar").height(a+"%");"100"==a&&$("#upimg .bar").html('<i class="fa fa-spinner fa-spin"></i>')}},!1);b.onreadystatechange=
function(a){4==b.readyState&&200==b.status&&""!=b.responseText?(a=JSON.parse(b.responseText),$(".chat-input .progress").remove(),$("#imageThumb").remove(),$("#upimg").css({background:"none","box-shadow":"none"}),a={key:a.key,path:"http://"+p+".qiniudn.com/"+a.key+"?imageView/1/w/200/h/200"},$("#upimg").append(ich.image_preview(a)),m=!1):200!=b.status&&b.responseText&&(console.log("xhr.responseText",b.responseText),console.log("response",a),m=!1)};f=(new Date).getTime();b.send(d)},error:function(){}})}},
!1);$(".chat-input").on("click","#previewControl .delete",function(){var a=$(this).data("id");$.ajax({url:"/delete",type:"POST",cache:!1,data:{key:a},dataType:"json",success:function(){$("#upimg").html("").hide()},error:function(a,b,d){console.log(a);console.log(b);console.log(d.error);f("error","\u51fa\u9519\u4e86\u3002"+d.error,2E3)}})}).on("click","#previewControl .publish",function(){var a=$(this).data("id").toString();d.emit("my msg",{msg:"http://"+p+".qiniudn.com/"+a+"?imageView/1/w/500/h/500",
imgKey:a});$("#upimg").html("").hide()});$("#front").click(function(){$(".fixed_block.null").addClass("flip")});$("#back2front").click(function(){$(".fixed_block.null").removeClass("flip")});$("#applyBtn").click(function(){var a=$(this),c=$("#input_name").val(),b=$("#input_email").val(),d=/^[a-z0-9]+([._\\-]*[a-z0-9])*@([a-z0-9]+[-a-z0-9]*[a-z0-9]+.){1,63}[a-z0-9]+$/g;20<c.length?f("error","\u540d\u79f0\u592a\u957f\u4e86",3E3):1>b.length?f("error","\u8fd8\u6ca1\u586b\u5199\u90ae\u7bb1",3E3):d.test(b)?
(a.attr("class","ui loading button").attr("disabled","disabled"),$("#input_name").val(""),$("#input_email").val(""),$.ajax({url:"/apply",type:"POST",cache:!1,data:{name:c,email:b},dataType:"json",success:function(b){"success"===b.status&&(f("success","\u5df2\u6536\u5230\u7533\u8bf7\uff0c\u7a0d\u540e\u4f1a\u6709\u4eba\u8054\u7cfb\u4f60",3E3),a.attr("class","ui green button").attr("disabled",""),$(".fixed_block.null").removeClass("flip"))},error:function(b,c,d){console.log(b);console.log(c);console.log(d.error);
f("error","\u51fa\u9519\u4e86\u3002"+d.error,2E3);a.attr("class","ui green button").attr("disabled","");$(".fixed_block.null").removeClass("flip")}})):f("error","\u8bf7\u68c0\u67e5\u90ae\u7bb1\u5730\u5740\u662f\u5426\u5199\u9519",3E3)});d.on("new vote",function(a){$("#count_upup").html(a.result.up+" \u8d5e\u6210");$("#count_down").html(a.result.down+" \u53cd\u5bf9");$("#vote_bar .button").removeClass("loading")});h="true"===v("voted")?{voted_class:"disabled",count_upup:null,count_down:null,voted:!0}:
{voted_class:"",count_upup:null,count_down:null,voted:!0};$("#vote_bar").append(ich.vote_template(h));$("#vote_bar .button").click(function(){if("true"!==v("voted")){var a=$(this);"v_upup"===a.attr("id")?d.emit("my vote",{vote:"up"}):d.emit("my vote",{vote:"down"});a.addClass("loading");$("#vote_bar .button").addClass("disabled");a=new Date;a.setTime(a.getTime()+1728E6);document.cookie="voted="+escape(!0)+";expires="+a.toGMTString()}});console.log("tit",escape("Maja&#039;s Song"))});